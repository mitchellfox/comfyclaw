<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ComfyClaw Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/duotone/style.css">
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/fill/style.css">
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0a0a0f;
      --bg-card: #12121a;
      --bg-card-hover: #1a1a26;
      --cyan: #00e5ff;
      --cyan-dim: #00e5ff33;
      --cyan-glow: #00e5ff18;
      --green: #4ade80;
      --red: #f87171;
      --yellow: #fbbf24;
      --text: #e8e8ef;
      --text-dim: #8888a0;
      --border: #1e1e2e;
      --font-mono: 'JetBrains Mono', monospace;
      --font-body: 'Inter', sans-serif;
      /* Backward-compatible aliases */
      --accent: var(--cyan);
      --accent-soft: var(--cyan-dim);
      --surface: var(--bg-card);
      --surface-2: var(--bg-card-hover);
      --muted: var(--text-dim);
      --danger: var(--red);
      --success: var(--green);
      --warning: var(--yellow);
      --glow: 0 8px 24px rgba(0,0,0,0.3);
      --radius-lg: 12px;
      --radius-md: 8px;
    }
    *,*::before,*::after { margin:0; padding:0; box-sizing:border-box }
    body { background:var(--bg); color:var(--text); font-family:var(--font-body); line-height:1.6; min-height:100vh }
    .ph-duotone { vertical-align:-0.125em; }

    header { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1.5rem; border-bottom:1px solid var(--border); background:#0a0a0fdd; backdrop-filter:blur(12px); position:sticky; top:0; z-index:5 }
    header h1 { font-family:var(--font-mono); font-size:1.05rem; margin:0; letter-spacing:-0.3px; font-weight:700; display:flex; align-items:center; gap:10px }
    header h1 span { color:var(--cyan); font-weight:700 }

    .tabs { display:flex; gap:0.5rem; background:var(--bg); padding:4px; border-radius:999px; border:1px solid var(--border) }
    .tab { font-family:var(--font-mono); padding:6px 16px; border-radius:999px; border:1px solid transparent; background:transparent; color:var(--text-dim); cursor:pointer; font-weight:600; font-size:0.8rem; transition:all 0.2s }
    .tab.active { background:var(--cyan); color:#000; box-shadow:0 0 16px rgba(0,229,255,0.3) }

    main { max-width:960px; margin:0 auto; padding:2rem 1.5rem 3rem; display:grid; gap:20px }
    .hidden { display:none }

    .panel { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px }
    .grid { display:grid; gap:16px }
    .grid.cards { grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)) }

    .card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:1.25rem; cursor:pointer; transition:border-color 0.3s, transform 0.2s, background 0.3s }
    .card:hover { transform:translateY(-2px); border-color:var(--cyan-dim); background:var(--bg-card-hover) }
    .card h3 { margin:0 0 6px 0; font-family:var(--font-mono); font-weight:700 }

    h2, h3, strong { color:var(--text); font-family:var(--font-mono); font-weight:700 }
    .muted { color:var(--text-dim) }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }

    input, textarea, select { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:0.75rem 1rem; border-radius:8px; font-family:var(--font-body); font-size:0.9rem; transition:border-color 0.2s }
    input:focus, textarea:focus, select:focus { outline:none; border-color:var(--cyan) }
    textarea { min-height:90px; resize:vertical }

    button, .primary { font-family:var(--font-mono); background:var(--cyan); color:#000; border:1px solid transparent; padding:0.6rem 1.25rem; border-radius:8px; cursor:pointer; font-weight:700; font-size:0.85rem; transition:all 0.2s }
    button:hover, .primary:hover { filter:brightness(1.15); transform:translateY(-1px); box-shadow:0 0 20px rgba(0,229,255,0.3) }
    button.secondary { background:transparent; border:1px solid var(--border); color:var(--text); box-shadow:none; filter:none }
    button.secondary:hover { border-color:var(--cyan); color:var(--cyan); box-shadow:none }
    button.danger { background:transparent; border:1px solid rgba(248,113,113,0.4); color:var(--red); box-shadow:none; filter:none }
    button.danger:hover { border-color:var(--red); box-shadow:none }

    .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; background:var(--text-dim) }
    .status-dot.ok { background:var(--green); box-shadow:0 0 10px rgba(74,222,128,0.5) }
    .status-dot.fail { background:var(--red); box-shadow:0 0 10px rgba(248,113,113,0.5) }

    .workflow-detail { margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px }
    .node-list { background:var(--bg-card-hover); border:1px solid var(--border); border-radius:8px; padding:12px; min-height:120px }
    .node-item { background:var(--bg); border:1px solid var(--border); padding:10px; border-radius:8px; margin-bottom:10px }
    .node-item:last-child { margin-bottom:0 }

    .pill { font-family:var(--font-mono); background:var(--cyan-dim); color:var(--cyan); padding:2px 8px; border-radius:999px; font-size:0.7rem; margin-left:6px }
    .tag { font-family:var(--font-mono); background:var(--cyan-dim); color:var(--cyan); padding:2px 10px; border-radius:999px; font-size:0.7rem }

    .section-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
    details summary { cursor:pointer; margin-bottom:8px; font-family:var(--font-mono); font-size:0.85rem }
    .output-list { margin-top:16px; background:var(--bg-card-hover); border:1px solid var(--border); border-radius:8px; padding:12px }
    .banner { padding:14px 16px; border-radius:12px; background:var(--bg-card-hover); border:1px solid var(--border); margin-bottom:12px }

    .workflow-tabs { display:flex; gap:0.5rem; margin-top:16px; flex-wrap:wrap }
    .workflow-tab { font-family:var(--font-mono); border:1px solid var(--border); background:var(--bg); color:var(--text-dim); padding:6px 16px; border-radius:999px; cursor:pointer; font-weight:600; font-size:0.8rem; transition:all 0.2s }
    .workflow-tab.active { background:var(--cyan); border-color:var(--cyan); color:#000; box-shadow:0 0 12px rgba(0,229,255,0.3) }

    .run-panel { display:grid; gap:12px }
    .run-panel > button { padding:0.75rem 1.25rem; font-size:0.95rem }

    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance:none; margin:0 }

    .status-pill { font-family:var(--font-mono); display:inline-flex; align-items:center; gap:8px; background:var(--bg); border:1px solid var(--border); padding:6px 12px; border-radius:999px; font-size:0.75rem; color:var(--text) }
    .status-pulse { display:inline-flex; align-items:center; gap:6px; font-family:var(--font-mono); font-weight:600 }
    .status-pulse::before { content:''; width:10px; height:10px; border-radius:50%; background:var(--yellow); box-shadow:0 0 10px rgba(251,191,36,0.6); animation:pulse 1.6s ease-in-out infinite }
    .status-pulse.complete::before { background:var(--green); box-shadow:0 0 10px rgba(74,222,128,0.6); animation:none }
    @keyframes pulse { 0%{transform:scale(0.9);opacity:0.7} 50%{transform:scale(1.2);opacity:1} 100%{transform:scale(0.9);opacity:0.7} }

    .gallery-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem }
    .gallery-card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; transition:border-color 0.3s, transform 0.2s }
    .gallery-card:hover { transform:translateY(-2px); border-color:var(--cyan-dim) }
    .gallery-thumb { width:100%; height:200px; border-radius:8px; background:var(--bg); display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid var(--border); cursor:pointer }
    .gallery-thumb img, .gallery-thumb video { width:100%; height:100%; object-fit:cover }
    .gallery-meta { font-family:var(--font-mono); font-size:0.7rem; color:var(--text-dim) }

    .modal { position:fixed; inset:0; background:#00000099; display:none; align-items:center; justify-content:center; padding:24px; z-index:10; backdrop-filter:blur(6px) }
    .modal.active { display:flex }
    .modal-card { background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:18px; max-width:900px; width:100%; display:grid; grid-template-columns:2fr 1fr; gap:16px; box-shadow:0 25px 60px rgba(0,0,0,0.6) }
    .modal-media img, .modal-media video { width:100%; max-height:520px; object-fit:contain; border-radius:12px; background:var(--bg) }
    .modal-sidebar { display:grid; gap:10px; font-size:13px }

    @media (max-width:900px) { header{flex-direction:column;align-items:flex-start;gap:12px} .modal-card{grid-template-columns:1fr} .workflow-detail{grid-template-columns:1fr} }

    #toast-container { position:fixed;bottom:24px;right:24px;z-index:10000;display:flex;flex-direction:column;gap:8px;pointer-events:none }
    .toast { background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-family:var(--font-mono);font-size:0.8rem;color:var(--text);box-shadow:0 8px 24px rgba(0,0,0,0.4);pointer-events:auto;animation:toastIn 0.3s ease;max-width:360px }
    .toast.out { animation:toastOut 0.3s ease forwards }
    @keyframes toastIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    @keyframes toastOut { from{opacity:1;transform:translateY(0)} to{opacity:0;transform:translateY(16px)} }
  </style>
</head>
<body>
<div id="toast-container"></div>
  <header>
    <h1><i class="ph-duotone ph-lightning"></i> <span>ComfyClaw</span> Dashboard</h1>
    <div class="tabs">
      <button class="tab active" data-tab="servers">Servers</button>
      <button class="tab" data-tab="workflows">Workflows</button>
      <button class="tab" data-tab="pipelines">Pipelines</button>
      <button class="tab" data-tab="gallery">Gallery</button>
      <button class="tab" data-tab="network"><i class="ph-duotone ph-currency-dollar" style="margin-right:0.35rem"></i>Network</button>
    </div>
  </header>

  <main>
    <section id="servers" class="panel">
      <div class="section-title">
        <h2>Servers</h2>
        <button id="add-server">Add Server</button>
      </div>
      <div id="servers-list" class="grid"></div>
    </section>

    <section id="workflows" class="panel hidden">
      <div class="section-title">
        <h2>Workflows</h2>
        <div class="row">
          <button id="add-workflow">Add Workflow</button>
          <button id="import-workflow" class="secondary">Import Workflow</button>
          <input id="import-file" type="file" accept="application/json" class="hidden" />
        </div>
      </div>
      <div id="workflow-cards" class="grid cards"></div>
      <div id="workflow-detail" class="banner hidden"></div>
    </section>

    <section id="pipelines" class="panel hidden">
      <div class="section-title">
        <h2>Pipelines</h2>
        <div class="row">
          <button id="add-pipeline">New Pipeline</button>
        </div>
      </div>
      <div id="pipeline-builder" class="panel"></div>
      <div id="pipeline-list" class="grid"></div>
    </section>

    <section id="gallery" class="panel hidden">
      <div class="section-title">
        <h2>Gallery</h2>
        <div class="row">
          <select id="gallery-filter"></select>
          <button id="refresh-gallery" class="secondary">Refresh</button>
        </div>
      </div>
      <div id="gallery-list" class="gallery-grid"></div>
    </section>

    <section id="network" class="panel hidden">
      <!-- State 1: Not registered — show the pitch -->
      <div id="net-pitch">
        <div style="text-align:center;padding:20px 0 10px">
          <div style="font-size:3em;margin-bottom:12px"><i class="ph-duotone ph-currency-dollar"></i></div>
          <h2 style="font-size:24px;margin:0;font-weight:800">Turn Your GPU Into a Business</h2>
          <p style="color:var(--muted);margin:8px 0 0;font-size:15px;max-width:500px;margin-left:auto;margin-right:auto">
            Your workflows get listed on <a href="https://comfyclaw.app" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600">comfyclaw.app</a> — a marketplace where anyone can pay to run them on your GPU. You set the price, we handle the rest.
          </p>
        </div>

        <!-- Revenue Calculator -->
        <div class="panel" style="background:var(--surface-2);margin-top:24px;padding:20px">
          <h3 style="font-size:15px;margin:0 0 16px"><i class="ph-duotone ph-chart-bar" style="margin-right:0.35rem"></i>Earnings Calculator</h3>
          <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr">
            <div>
              <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">Avg price per run</label>
              <div style="display:flex;align-items:center;gap:4px">
                <span style="color:var(--success);font-weight:700">$</span>
                <input type="number" id="calc-price" value="0.35" min="0.05" max="50" step="0.05" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);width:100%;font-size:14px" oninput="calcEarnings()">
              </div>
            </div>
            <div>
              <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">Runs per day</label>
              <input type="range" id="calc-runs" min="10" max="1000" value="100" style="width:100%;accent-color:var(--accent)" oninput="calcEarnings()">
              <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)"><span>10</span><span id="calc-runs-val">100</span><span>1000</span></div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px">
            <div style="text-align:center;padding:16px;background:var(--bg);border-radius:12px">
              <div style="font-size:1.4em;font-weight:800;color:var(--success)" id="calc-daily">$35</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px">Per Day</div>
            </div>
            <div style="text-align:center;padding:16px;background:var(--bg);border-radius:12px">
              <div style="font-size:1.4em;font-weight:800;color:var(--success)" id="calc-monthly">$1,050</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px">Per Month</div>
            </div>
            <div style="text-align:center;padding:16px;background:var(--bg);border-radius:12px">
              <div style="font-size:1.4em;font-weight:800;color:var(--accent)" id="calc-yearly">$12,600</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px">Per Year</div>
            </div>
          </div>
        </div>

        <!-- How it Works -->
        <div class="panel" style="background:var(--surface-2);margin-top:20px;padding:20px">
          <h3 style="font-size:15px;margin:0 0 16px">How It Works</h3>
          <div style="display:grid;gap:14px">
            <div style="display:flex;gap:14px;align-items:flex-start">
              <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-soft);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;color:var(--accent);font-size:14px">1</div>
              <div>
                <div style="font-weight:600;font-size:14px">Enable your workflows</div>
                <div style="font-size:12px;color:var(--muted)">Choose which workflows to share and set your price per run. Your workflow files stay private — only the input form is exposed.</div>
              </div>
            </div>
            <div style="display:flex;gap:14px;align-items:flex-start">
              <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-soft);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;color:var(--accent);font-size:14px">2</div>
              <div>
                <div style="font-weight:600;font-size:14px">They appear on <a href="https://comfyclaw.app" target="_blank" style="color:var(--accent);text-decoration:none">comfyclaw.app</a></div>
                <div style="font-size:12px;color:var(--muted)">Your workflows are instantly listed on the marketplace. Users browse, pick a workflow, fill in their prompt, and hit generate.</div>
              </div>
            </div>
            <div style="display:flex;gap:14px;align-items:flex-start">
              <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-soft);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;color:var(--accent);font-size:14px">3</div>
              <div>
                <div style="font-weight:600;font-size:14px">Jobs run on your GPU automatically</div>
                <div style="font-size:12px;color:var(--muted)">Your machine connects out to the network (no port forwarding). When someone pays to run your workflow, it executes on your local ComfyUI and sends back the result.</div>
              </div>
            </div>
            <div style="display:flex;gap:14px;align-items:flex-start">
              <div style="width:32px;height:32px;border-radius:50%;background:rgba(34,197,94,0.15);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;color:var(--success);font-size:14px">$</div>
              <div>
                <div style="font-weight:600;font-size:14px">Money hits your bank account</div>
                <div style="font-size:12px;color:var(--muted)">Earnings are tracked per job. Payouts are automatic via Stripe once you connect your bank. Your workflow IP is never exposed.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- CTA -->
        <div class="panel" style="background:var(--surface-2);margin-top:24px;padding:28px;text-align:center">
          <h3 style="font-size:18px;margin:0 0 8px"><i class="ph-duotone ph-rocket-launch" style="margin-right:0.4rem"></i>Ready to Start Earning?</h3>
          <p style="color:var(--muted);font-size:13px;margin:0 0 20px">Create your account on comfyclaw.app to get set up with secure payments via Stripe.</p>
          <a href="https://comfyclaw.app/provider/signup" target="_blank" class="primary" style="display:inline-block;padding:14px 32px;font-size:16px;font-weight:700;text-decoration:none;border-radius:12px;background:var(--accent);color:var(--bg)">Sign Up on comfyclaw.app →</a>
        </div>

        <!-- API Key Connection — prominent step -->
        <div class="panel" style="background:var(--surface-2);margin-top:20px;padding:24px">
          <div style="display:flex;align-items:flex-start;gap:14px">
            <div style="width:36px;height:36px;border-radius:50%;background:var(--accent-soft);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px"><i class="ph-duotone ph-key"></i></div>
            <div style="flex:1">
              <h3 style="font-size:15px;margin:0 0 4px">Already have an account?</h3>
              <p style="color:var(--muted);font-size:13px;margin:0 0 14px">Paste your API key from <a href="https://comfyclaw.app/account" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600">comfyclaw.app/account</a> to connect this machine to the network.</p>
              <div style="display:flex;gap:8px;max-width:460px">
                <input type="text" id="net-existing-key" placeholder="ccn_sk_..." style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;font-family:'JetBrains Mono',monospace;flex:1" onkeydown="if(event.key==='Enter')netLoginKey()">
                <button class="primary" onclick="netLoginKey()" style="padding:10px 20px;font-size:13px;font-weight:700;white-space:nowrap">Connect →</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- State 2: Registered — provider dashboard -->
      <div id="net-dashboard" style="display:none">
        <div class="section-title">
          <h2><i class="ph-duotone ph-currency-dollar" style="margin-right:0.35rem"></i>Network</h2>
          <div class="row" style="gap:8px;align-items:center">
            <span id="net-status-dot" style="width:10px;height:10px;border-radius:50%;background:#f35d6a;display:inline-block"></span>
            <span id="net-status-text" style="color:var(--muted);font-size:13px">Checking...</span>
          </div>
        </div>

        <!-- Onboarding Banner (shown when Stripe setup incomplete) -->
        <div id="net-onboarding-banner" style="display:none;margin-top:16px"></div>

        <!-- Payout Method Banner (shown when no Stripe connected) -->
        <div id="net-payout-banner" style="display:none;margin-top:16px">
          <div class="panel" style="background:linear-gradient(135deg, rgba(0,229,255,0.04), rgba(34,197,94,0.04));border:1px solid var(--border);padding:20px;border-radius:12px">
            <div style="display:flex;align-items:center;gap:14px">
              <div style="font-size:1.8em;flex-shrink:0"><i class="ph-duotone ph-credit-card"></i></div>
              <div style="flex:1">
                <h3 style="font-size:15px;margin:0 0 4px">Start Earning Money</h3>
                <p style="color:var(--muted);font-size:13px;margin:0">Your workflows are currently shared for free. Connect Stripe to set your own prices and receive payouts to your bank account.</p>
              </div>
              <a href="https://comfyclaw.app/provider" target="_blank" style="background:var(--accent);color:var(--bg);padding:10px 20px;border-radius:8px;font-size:13px;font-weight:700;text-decoration:none;white-space:nowrap;flex-shrink:0">Set Up Payouts →</a>
            </div>
          </div>
        </div>

        <!-- Earnings Cards -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px">
          <div class="panel" style="background:var(--surface-2);text-align:center;padding:20px">
            <div style="font-size:1.6em;font-weight:800;color:var(--success)" id="net-earned">$0.00</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px">Total Earned</div>
          </div>
          <div class="panel" style="background:var(--surface-2);text-align:center;padding:20px">
            <div style="font-size:1.6em;font-weight:800;color:var(--warning)" id="net-pending">$0.00</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px">Pending Payout</div>
          </div>
          <div class="panel" style="background:var(--surface-2);text-align:center;padding:20px">
            <div style="font-size:1.6em;font-weight:800;color:var(--accent)" id="net-transferred">$0.00</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px">Transferred</div>
          </div>
        </div>

        <!-- GPU Connection Control -->
        <div class="panel" style="background:var(--surface-2);margin-top:16px;padding:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;align-items:center;gap:10px">
              <span id="net-conn-dot" style="width:12px;height:12px;border-radius:50%;background:var(--danger);display:inline-block"></span>
              <div>
                <h3 style="font-size:14px;margin:0"><i class="ph-duotone ph-lightning" style="margin-right:0.35rem"></i>GPU Connection</h3>
                <span id="net-conn-text" style="color:var(--muted);font-size:12px">Disconnected</span>
              </div>
            </div>
            <div id="net-conn-btns">
              <button class="primary" id="net-start-btn" onclick="netStartConnect()" style="padding:8px 18px;font-size:13px;font-weight:600"><i class="ph-duotone ph-play" style="margin-right:0.35rem"></i>Start</button>
              <button class="secondary" id="net-stop-btn" onclick="netStopConnect()" style="padding:8px 18px;font-size:13px;display:none;color:var(--danger)"><i class="ph-duotone ph-stop-circle" style="margin-right:0.35rem"></i>Stop</button>
            </div>
          </div>
          <div id="net-conn-log" style="display:none;margin-top:12px;background:var(--bg);border-radius:8px;padding:10px 14px;max-height:150px;overflow-y:auto;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.6;color:var(--muted)"></div>
        </div>

        <!-- Live Marketplace Link -->
        <div class="panel" style="background:var(--surface-2);margin-top:16px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:13px;font-weight:600"><i class="ph-duotone ph-globe" style="margin-right:0.35rem"></i>Your Marketplace</div>
            <div style="font-size:12px;color:var(--muted)">Enabled workflows appear here for anyone to use</div>
          </div>
          <a href="https://comfyclaw.app" target="_blank" style="background:var(--accent);color:var(--bg);padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;text-decoration:none;white-space:nowrap">Visit comfyclaw.app →</a>
        </div>

        <!-- Workflows with Pricing -->
        <div style="margin-top:20px">
          <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px">
            <h3 style="font-size:15px;margin:0">Your Workflows</h3>
            <span style="font-size:12px;color:var(--muted)">Toggle on = live on comfyclaw.app</span>
          </div>
          <div id="net-workflows" style="display:grid;gap:10px"></div>
        </div>

        <!-- Recent Earnings -->
        <div style="margin-top:20px">
          <h3 style="font-size:15px;margin:0 0 12px">Recent Earnings</h3>
          <div id="net-earnings" style="display:grid;gap:4px"></div>
        </div>

        <!-- Disconnect -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
          <!-- Disconnect button removed: stopping GPU connection is sufficient -->
        </div>
      </div>
    </section>
  </main>

  <div id="preview-modal" class="modal">
    <div class="modal-card">
      <div class="modal-media" id="modal-media"></div>
      <div class="modal-sidebar" id="modal-meta"></div>
    </div>
  </div>

  <template id="server-form">
    <div class="panel">
      <div class="row">
        <label>Name
          <input name="name" />
        </label>
        <label>URL
          <input name="url" />
        </label>
      </div>
      <div class="row">
        <label>API Key
          <input name="apiKey" />
        </label>
        <label>Default
          <select name="isDefault">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button class="save">Save</button>
        <button class="secondary cancel">Cancel</button>
      </div>
    </div>
  </template>

  <template id="workflow-form">
    <div class="panel">
      <div class="row">
        <label>Title
          <input name="title" />
        </label>
        <label>Emoji
          <input name="emoji" />
        </label>
      </div>
      <label>Description
        <textarea name="description"></textarea>
      </label>
      <label>Server
        <select name="serverRef"></select>
      </label>
      <div class="row">
        <button class="save">Save</button>
        <button class="secondary cancel">Cancel</button>
      </div>
    </div>
  </template>

  <script>
    function toast(msg, durationMs = 3000) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerHTML = msg;
      document.getElementById('toast-container').appendChild(el);
      setTimeout(() => { el.classList.add('out'); setTimeout(() => el.remove(), 300); }, durationMs);
    }

    const api = {
      async get(path) {
        const res = await fetch(path);
        return res.json();
      },
      async post(path, payload) {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload || {})
        });
        return res.json();
      },
      async put(path, payload) {
        const res = await fetch(path, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload || {})
        });
        return res.json();
      },
      async del(path) {
        const res = await fetch(path, { method: 'DELETE' });
        return res.json();
      }
    };

    const state = {
      servers: [],
      workflows: [],
      templates: [],
      pipelines: [],
      gallery: [],
      activeWorkflow: null,
      lastStatus: {}
    };

    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

    function switchTab(id) {
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === id));
      document.getElementById('servers').classList.toggle('hidden', id !== 'servers');
      document.getElementById('workflows').classList.toggle('hidden', id !== 'workflows');
      document.getElementById('pipelines').classList.toggle('hidden', id !== 'pipelines');
      document.getElementById('gallery').classList.toggle('hidden', id !== 'gallery');
      document.getElementById('network').classList.toggle('hidden', id !== 'network');
      if (id === 'gallery') {
        refreshGallery();
      }
      if (id === 'pipelines') {
        renderPipelines();
      }
      if (id === 'network') {
        netInit();
      }
    }

    // --- Network (Provider) ---
    const GW_URL = localStorage.getItem('ccn_gateway_url') || 'https://comfyclaw.app';
    let netProviderKey = localStorage.getItem('ccn_provider_key') || '';
    let netProviderStatus = 'unknown';
    let netHasPayoutMethod = false;
    let netWfStats = {};

    function calcEarnings() {
      const price = parseFloat(document.getElementById('calc-price').value) || 0.35;
      const runs = parseInt(document.getElementById('calc-runs').value) || 100;
      document.getElementById('calc-runs-val').textContent = runs;
      const daily = price * runs;
      const monthly = daily * 30;
      const yearly = daily * 365;
      document.getElementById('calc-daily').textContent = '$' + daily.toFixed(0);
      document.getElementById('calc-monthly').textContent = '$' + monthly.toLocaleString('en-US', {maximumFractionDigits: 0});
      document.getElementById('calc-yearly').textContent = '$' + yearly.toLocaleString('en-US', {maximumFractionDigits: 0});
    }

    async function netInit() {
      netProviderKey = localStorage.getItem('ccn_provider_key') || '';
      if (netProviderKey) {
        document.getElementById('net-pitch').style.display = 'none';
        document.getElementById('net-dashboard').style.display = '';
        await netRefreshDashboard();
      } else {
        document.getElementById('net-pitch').style.display = '';
        document.getElementById('net-dashboard').style.display = 'none';
        calcEarnings();
      }
    }

    async function netProviderApi(path, opts = {}) {
      const headers = opts.headers || {};
      headers['Authorization'] = `Bearer ${netProviderKey}`;
      if (opts.body) headers['Content-Type'] = 'application/json';
      return fetch(GW_URL + '/api/v1' + path, { ...opts, headers });
    }

    async function netLoginKey() {
      const key = document.getElementById('net-existing-key').value.trim();
      if (!key) return;
      localStorage.setItem('ccn_provider_key', key);
      netProviderKey = key;
      // Auto-register as provider if not already one
      try {
        const res = await netProviderApi('/provider/status');
        if (res.status === 404) {
          await fetch(GW_URL + '/api/v1/auth/provider-register', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: '' })
          });
        }
      } catch(e) { /* gateway offline, will retry on refresh */ }
      toast('<i class="ph-duotone ph-link" style="margin-right:0.35rem"></i>Provider account connected');
      await netInit();
      // Auto-start GPU connection
      await netStartConnect();
    }

    async function netRefreshDashboard() {
      // Fetch provider status
      const dot = document.getElementById('net-status-dot');
      const text = document.getElementById('net-status-text');
      try {
        const res = await netProviderApi('/provider/status');
        if (res.status === 401) { netLogout(); return; }
        const data = await res.json();
        const status = data.provider?.status || 'unknown';
        netProviderStatus = status;
        netHasPayoutMethod = !!data.provider?.stripe_account_id;
        // Registration status stored but dot/text reflect live GPU connection (updated by netPollConnection)
        if (status === 'onboarding' || status === 'pending') {
          dot.style.background = 'var(--warning)';
          text.textContent = 'Complete Stripe setup';
        }
        // For active providers, default to offline until netPollConnection confirms
        if (status === 'active') {
          dot.style.background = 'var(--danger)';
          text.textContent = 'GPU Offline';
        }
        // Handle onboarding state
        const onboardingBanner = document.getElementById('net-onboarding-banner');
        if (status === 'onboarding' || status === 'pending') {
          onboardingBanner.style.display = '';
          onboardingBanner.innerHTML = `
            <div class="panel" style="background:rgba(251,191,36,0.1);border:1px solid var(--warning);padding:20px;text-align:center">
              <div style="font-size:1.5em;margin-bottom:8px"><i class="ph-duotone ph-warning" style="color:var(--warning)"></i></div>
              <h3 style="font-size:15px;margin:0 0 6px">Complete Your Stripe Setup</h3>
              <p style="color:var(--muted);font-size:13px;margin:0 0 14px">You need to finish Stripe onboarding to receive payouts. Your workflows can run for free until then.</p>
              <button class="primary" onclick="netResumeOnboarding()" id="net-resume-btn" style="padding:10px 24px;font-size:14px">Complete Stripe Setup →</button>
            </div>
          `;
        } else {
          onboardingBanner.style.display = 'none';
        }
        // Show/hide payout banner
        const payoutBanner = document.getElementById('net-payout-banner');
        if (payoutBanner) payoutBanner.style.display = netHasPayoutMethod ? 'none' : '';
        // Earnings
        const earn = data.earnings || {};
        document.getElementById('net-earned').textContent = '$' + ((earn.total_cents || 0) / 100).toFixed(2);
        document.getElementById('net-pending').textContent = '$' + ((earn.pending_cents || 0) / 100).toFixed(2);
        document.getElementById('net-transferred').textContent = '$' + ((earn.transferred_cents || 0) / 100).toFixed(2);
      } catch(e) {
        dot.style.background = 'var(--danger)';
        text.textContent = 'Gateway offline';
      }
      // Poll connection status
      netPollConnection();
      if (!netConnInterval) netConnInterval = setInterval(netPollConnection, 5000);
      // Fetch workflow stats
      try {
        const statsRes = await netProviderApi('/workflows/stats');
        if (statsRes.ok) netWfStats = await statsRes.json();
      } catch(e) {}
      // Render workflows
      netRenderWorkflows();
      // Fetch earnings list
      netRenderEarnings();
    }

    function netRenderWorkflows() {
      const el = document.getElementById('net-workflows');
      if (!state.workflows?.length) { el.innerHTML = '<div style="color:var(--muted)">No workflows yet. Add one in the Workflows tab!</div>'; return; }
      el.innerHTML = state.workflows.map(wf => {
        const pub = wf.published ? true : false;
        const price = wf.provider_price_cents ? (wf.provider_price_cents / 100).toFixed(2) : '';
        const defaultPrice = wf.outputType === 'video' ? '2.00' : wf.title?.includes('I2I') ? '0.50' : '0.35';
        const displayPrice = price || defaultPrice;
        const consumerPrice = (parseFloat(displayPrice) * 1.4).toFixed(2);
        const stats = netWfStats[wf.id] || {};
        const totalRuns = stats.total_runs || 0;
        const completedRuns = stats.completed_runs || 0;
        return `<div style="padding:14px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:12px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="display:flex;align-items:center;gap:10px">
              <span style="font-size:1.3em">${wf.emoji || '<i class="ph-duotone ph-puzzle-piece" style="font-size:1.3em"></i>'}</span>
              <div>
                <div style="font-weight:600;font-size:14px">${wf.title || 'Untitled'}</div>
                <div style="font-size:12px;color:var(--muted)">${(wf.primaryInputNodes || []).length} inputs · ${totalRuns > 0 ? `<span style="color:var(--accent)">${completedRuns}/${totalRuns} runs</span>` : 'No runs yet'}</div>
              </div>
            </div>
            <label style="position:relative;width:44px;height:24px;cursor:pointer">
              <input type="checkbox" ${pub ? 'checked' : ''} onchange="netToggleWf('${wf.id}', this.checked)" style="opacity:0;width:0;height:0;position:absolute">
              <span style="position:absolute;inset:0;background:${pub ? 'var(--accent)' : 'var(--border)'};border-radius:24px;transition:0.2s"></span>
              <span style="position:absolute;top:3px;left:${pub ? '23px' : '3px'};width:18px;height:18px;background:#fff;border-radius:50%;transition:0.2s"></span>
            </label>
          </div>
          ${pub ? netHasPayoutMethod ? `<div style="display:flex;align-items:center;gap:12px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
            <div style="flex:1">
              <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:3px">Your price</label>
              <div style="display:flex;align-items:center;gap:4px">
                <span style="color:var(--success);font-weight:700;font-size:13px">$</span>
                <input type="number" value="${displayPrice}" min="0.05" step="0.05" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);width:80px;font-size:13px" onchange="netSetPrice('${wf.id}', this.value)">
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-size:11px;color:var(--muted)">Consumer pays</div>
              <div style="font-size:14px;font-weight:700;color:var(--success)">$${consumerPrice}</div>
            </div>
          </div>` : `<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
            <div>
              <span style="font-size:13px;font-weight:700;color:var(--muted)">$0.00</span>
              <span style="font-size:11px;color:var(--muted);margin-left:6px">Connect a payout method to set prices</span>
            </div>
          </div>` : ''}
        </div>`;
      }).join('');
    }

    async function netToggleWf(wfId, publish) {
      const wf = state.workflows.find(w => w.id === wfId);
      if (!wf) return;
      wf.published = publish;
      await api.put('/api/workflows/' + wfId, wf);
      toast(publish ? `<i class="ph-duotone ph-check-circle" style="color:var(--success);margin-right:0.35rem"></i>${wf.emoji || '<i class="ph-duotone ph-puzzle-piece"></i>'} ${wf.title || 'Workflow'} is now live` : `<i class="ph-duotone ph-pause-circle" style="color:var(--warning);margin-right:0.35rem"></i>${wf.emoji || '<i class="ph-duotone ph-puzzle-piece"></i>'} ${wf.title || 'Workflow'} taken offline`);
      netRenderWorkflows();
      // Refresh network connection so gateway sees updated workflow list
      try {
        await fetch('/api/network/refresh-workflows', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ gateway_url: GW_URL, api_key: netProviderKey })
        });
      } catch(e) {}
    }

    async function netSetPrice(wfId, price) {
      const cents = Math.round(parseFloat(price) * 100);
      if (cents < 5) return;
      const wf = state.workflows.find(w => w.id === wfId);
      if (!wf) return;
      wf.provider_price_cents = cents;
      await api.put('/api/workflows/' + wfId, wf);
      netRenderWorkflows();
    }

    async function netRenderEarnings() {
      const el = document.getElementById('net-earnings');
      try {
        const res = await netProviderApi('/provider/earnings');
        const earnings = await res.json();
        if (!Array.isArray(earnings) || !earnings.length) {
          el.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:12px">No earnings yet. Enable workflows above, run the connect command, and users on <a href="https://comfyclaw.app" target="_blank" style="color:var(--accent)">comfyclaw.app</a> will start sending you jobs!</div>';
          return;
        }
        el.innerHTML = earnings.slice(0, 10).map(e => {
          const date = e.created_at ? new Date(e.created_at * 1000).toLocaleDateString() : '—';
          const statusColor = e.status === 'transferred' ? 'var(--success)' : e.status === 'pending' ? 'var(--warning)' : 'var(--danger)';
          return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface-2);border-radius:8px;font-size:13px">
            <code style="font-size:11px;color:var(--muted)">${(e.job_id || '').slice(0,12)}…</code>
            <span style="font-weight:700">$${(e.amount_cents / 100).toFixed(2)}</span>
            <span style="color:${statusColor};font-size:11px">${e.status}</span>
            <span style="color:var(--muted);font-size:11px">${date}</span>
          </div>`;
        }).join('');
      } catch(e) { el.innerHTML = '<div style="color:var(--muted);font-size:13px">Could not load earnings</div>'; }
    }

    let netConnInterval = null;

    async function netStartConnect() {
      const btn = document.getElementById('net-start-btn');
      btn.disabled = true; btn.textContent = 'Starting...';
      try {
        const res = await fetch('/api/network/start', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ gateway_url: GW_URL, api_key: netProviderKey })
        });
        const data = await res.json();
        if (data.status === 'started' || data.status === 'already_running') {
          toast('<i class="ph-duotone ph-lightning" style="margin-right:0.35rem"></i>GPU connection started');
          netPollConnection();
          if (!netConnInterval) netConnInterval = setInterval(netPollConnection, 3000);
        }
      } catch(e) { console.error(e); }
      btn.disabled = false; btn.innerHTML = '<i class="ph-duotone ph-play" style="margin-right:0.35rem"></i>Start';
    }

    async function netStopConnect() {
      const btn = document.getElementById('net-stop-btn');
      btn.disabled = true; btn.textContent = 'Stopping...';
      try {
        await fetch('/api/network/stop', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}' });
      } catch(e) {}
      btn.disabled = false; btn.innerHTML = '<i class="ph-duotone ph-stop-circle" style="margin-right:0.35rem"></i>Stop';
      // Clear connection log
      const logEl = document.getElementById('net-conn-log');
      if (logEl) { logEl.innerHTML = ''; logEl.style.display = 'none'; }
      toast('<i class="ph-duotone ph-stop-circle" style="margin-right:0.35rem"></i>GPU connection stopped');
      netPollConnection();
    }

    async function netPollConnection() {
      try {
        const res = await fetch('/api/network/status');
        const data = await res.json();
        const dot = document.getElementById('net-conn-dot');
        const text = document.getElementById('net-conn-text');
        const startBtn = document.getElementById('net-start-btn');
        const stopBtn = document.getElementById('net-stop-btn');
        const logEl = document.getElementById('net-conn-log');
        const topDot = document.getElementById('net-status-dot');
        const topText = document.getElementById('net-status-text');
        if (data.running) {
          dot.style.background = 'var(--success)';
          text.textContent = `Connected (PID ${data.pid})`;
          startBtn.style.display = 'none';
          stopBtn.style.display = '';
          if (topDot) topDot.style.background = 'var(--success)';
          if (topText) topText.textContent = 'GPU Online';
          // Show log
          if (data.log && data.log.length) {
            logEl.style.display = '';
            logEl.innerHTML = data.log.map(l => `<div>${l.line.replace(/</g,'&lt;')}</div>`).join('');
            logEl.scrollTop = logEl.scrollHeight;
          }
        } else {
          // Local subprocess not running — check if GPU is connected externally (e.g. CLI started manually)
          let externallyConnected = false;
          try {
            const gwHealth = await fetch(GW_URL + '/api/v1/health');
            if (gwHealth.ok) {
              const gwData = await gwHealth.json();
              externallyConnected = (gwData.connected_providers || 0) > 0;
            }
          } catch(e) {}
          if (externallyConnected) {
            dot.style.background = 'var(--success)';
            text.textContent = 'Connected (external)';
            startBtn.style.display = 'none';
            stopBtn.style.display = '';
            if (topDot) topDot.style.background = 'var(--success)';
            if (topText) topText.textContent = 'GPU Online';
          } else {
            dot.style.background = 'var(--danger)';
            text.textContent = 'Disconnected';
            startBtn.style.display = '';
            stopBtn.style.display = 'none';
            if (topDot) topDot.style.background = 'var(--danger)';
            if (topText) topText.textContent = 'GPU Offline';
          }
          if (!externallyConnected && netConnInterval) { clearInterval(netConnInterval); netConnInterval = null; }
          // Show last log lines if any
          if (data.log && data.log.length) {
            logEl.style.display = '';
            logEl.innerHTML = data.log.map(l => `<div>${l.line.replace(/</g,'&lt;')}</div>`).join('');
          }
        }
      } catch(e) {}
    }

    async function netResumeOnboarding() {
      const btn = document.getElementById('net-resume-btn');
      if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }
      try {
        const res = await netProviderApi('/provider/onboarding-link', { method: 'POST' });
        const data = await res.json();
        if (data.url) {
          window.open(data.url, '_blank');
        } else {
          alert(data.error || 'Failed to get onboarding link. Try again.');
        }
      } catch(e) { alert('Connection error'); }
      if (btn) { btn.disabled = false; btn.textContent = 'Complete Stripe Setup →'; }
    }

    async function netLogout() {
      // Stop GPU connection before disconnecting
      try { await fetch('/api/network/stop', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}' }); } catch(e) {}
      localStorage.removeItem('ccn_provider_key');
      netProviderKey = '';
      if (netConnInterval) { clearInterval(netConnInterval); netConnInterval = null; }
      const logEl = document.getElementById('net-conn-log');
      if (logEl) { logEl.innerHTML = ''; logEl.style.display = 'none'; }
      toast('<i class="ph-duotone ph-plug" style="margin-right:0.35rem"></i>Provider account disconnected');
      netInit();
    }

    setInterval(() => { if (!document.getElementById('network')?.classList.contains('hidden') && netProviderKey) netRefreshDashboard(); }, 15000);

    async function load() {
      state.servers = await api.get('/api/servers');
      state.workflows = await api.get('/api/workflows');
      state.templates = await api.get('/api/templates');
      state.pipelines = await api.get('/api/pipelines');
      renderServers();
      renderWorkflows();
      populateGalleryFilter();
      renderPipelines();
    }

    function renderServers() {
      const container = document.getElementById('servers-list');
      container.innerHTML = '';
      state.servers.forEach(server => {
        const card = document.createElement('div');
        card.className = 'panel';
        const status = state.lastStatus[server.id];
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div>
              <strong>${server.name}</strong>
              <div class="muted">${server.url}</div>
            </div>
            <div>
              <span class="status-dot ${status === true ? 'ok' : status === false ? 'fail' : ''}"></span>
              <span class="muted">${server.isDefault ? 'Default' : ''}</span>
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button data-action="test">Test</button>
            <button class="secondary" data-action="edit">Edit</button>
            <button class="danger" data-action="delete">Delete</button>
          </div>
        `;
        card.querySelector('[data-action="test"]').onclick = async () => {
          const res = await api.post(`/api/servers/${server.id}/test`);
          state.lastStatus[server.id] = !!res.ok;
          renderServers();
        };
        card.querySelector('[data-action="edit"]').onclick = () => openServerForm(server);
        card.querySelector('[data-action="delete"]').onclick = async () => {
          if (!confirm('Delete server?')) return;
          await api.del(`/api/servers/${server.id}`);
          await load();
        };
        container.appendChild(card);
      });
    }

    function openServerForm(server) {
      const template = document.getElementById('server-form');
      const form = template.content.cloneNode(true);
      const panel = form.querySelector('.panel');
      const name = panel.querySelector('[name=name]');
      const url = panel.querySelector('[name=url]');
      const apiKey = panel.querySelector('[name=apiKey]');
      const isDefault = panel.querySelector('[name=isDefault]');
      if (server) {
        name.value = server.name;
        url.value = server.url;
        apiKey.value = server.apiKey || '';
        isDefault.value = String(!!server.isDefault);
      }
      panel.querySelector('.save').onclick = async () => {
        const payload = {
          name: name.value,
          url: url.value,
          apiKey: apiKey.value,
          isDefault: isDefault.value === 'true'
        };
        if (server) {
          await api.put(`/api/servers/${server.id}`, payload);
        } else {
          await api.post('/api/servers', payload);
        }
        await load();
      };
      panel.querySelector('.cancel').onclick = () => load();
      const container = document.getElementById('servers-list');
      container.innerHTML = '';
      container.appendChild(panel);
    }

    function renderWorkflows() {
      const container = document.getElementById('workflow-cards');
      container.innerHTML = '';
      state.workflows.forEach(workflow => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${workflow.emoji || '<i class="ph-duotone ph-puzzle-piece"></i>'} ${workflow.title}</h3>
          <div class="muted">${workflow.description || ''}</div>
        `;
        card.onclick = () => openWorkflowDetail(workflow);
        container.appendChild(card);
      });
    }

    function openWorkflowDetail(workflow) {
      state.activeWorkflow = workflow;
      const detail = document.getElementById('workflow-detail');
      detail.classList.remove('hidden');
      detail.innerHTML = '';
      const serverOptions = state.servers.map(s => `<option value="${s.id}" ${s.id === workflow.serverRef ? 'selected' : ''}>${s.name}</option>`).join('');
      const primaryInputs = renderNodeList(workflow.primaryInputNodes, true);
      const secondaryInputs = renderNodeList(workflow.secondaryInputNodes, false);
      const outputs = renderNodeList(workflow.primaryOutputNodes || [], false, true);
      detail.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div>
            <h3>${workflow.emoji || '<i class="ph-duotone ph-puzzle-piece"></i>'} ${workflow.title}</h3>
            <div class="muted">${workflow.description || ''}</div>
          </div>
          <div class="row">
            <button class="secondary" id="close-detail">Close</button>
            <button class="danger" id="delete-workflow">Delete</button>
          </div>
        </div>
        <div class="workflow-tabs">
          <button class="workflow-tab active" data-view="setup">Setup</button>
          <button class="workflow-tab" data-view="run">Run</button>
          <button class="workflow-tab" data-view="gallery">Gallery</button>
        </div>
        <div id="workflow-view-setup">
          <div class="row" style="margin-top:12px;">
            <label>Title
              <input id="wf-title" value="${workflow.title}" />
            </label>
            <label>Emoji
              <input id="wf-emoji" value="${workflow.emoji || ''}" />
            </label>
          </div>
          <label>Description
            <textarea id="wf-desc">${workflow.description || ''}</textarea>
          </label>
          <label>Server
            <select id="wf-server">${serverOptions}</select>
          </label>
          <div class="workflow-detail">
            <div>
              <div class="section-title">
                <strong>Primary Inputs</strong>
              </div>
              <div class="node-list" id="primary-inputs">${primaryInputs}</div>
            </div>
            <div>
              <details>
                <summary><strong>Secondary Inputs</strong></summary>
                <div class="node-list" id="secondary-inputs">${secondaryInputs}</div>
              </details>
            </div>
          </div>
          <div class="output-list">
            <strong>Primary Outputs</strong>
            ${outputs}
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="save-workflow">Save</button>
          </div>
        </div>
        <div id="workflow-view-run" class="hidden">
          <div class="run-panel">
            <div id="run-templates"></div>
            <div id="run-inputs"></div>
            <div class="row" style="justify-content:space-between;">
              <button id="save-template" class="secondary">Save as Template</button>
              <div class="row">
                <button id="batch-workflow" class="secondary">Batch</button>
                <button id="run-workflow">Generate</button>
              </div>
            </div>
            <div id="batch-panel" class="panel hidden" style="margin-top:10px;">
              <div class="muted" style="margin-bottom:6px;">Batch settings</div>
              <div class="row" style="align-items:center;gap:12px;">
                <label style="flex:1;">Count
                  <input id="batch-count" type="range" min="2" max="10" value="3" />
                </label>
                <div id="batch-count-display" class="status-pill">3</div>
                <label class="row" style="gap:6px;align-items:center;">
                  <input id="batch-vary-seed" type="checkbox" checked />
                  <span>Vary Seed</span>
                </label>
                <button id="run-batch">Run Batch</button>
              </div>
              <div id="batch-progress" class="muted" style="margin-top:8px;"></div>
            </div>
            <div id="run-status" class="muted"></div>
            <div id="run-output"></div>
          </div>
        </div>
        <div id="workflow-view-gallery" class="hidden">
          <div id="workflow-gallery" class="gallery-grid"></div>
        </div>
      `;

      detail.querySelectorAll('.workflow-tab').forEach(tab => {
        tab.onclick = () => switchWorkflowView(detail, tab.dataset.view);
      });

      detail.querySelector('#close-detail').onclick = () => {
        detail.classList.add('hidden');
      };
      detail.querySelector('#delete-workflow').onclick = async () => {
        if (!confirm('Delete workflow?')) return;
        await api.del(`/api/workflows/${workflow.id}`);
        detail.classList.add('hidden');
        await load();
      };
      detail.querySelector('#save-workflow').onclick = async () => {
        workflow.title = detail.querySelector('#wf-title').value;
        workflow.emoji = detail.querySelector('#wf-emoji').value;
        workflow.description = detail.querySelector('#wf-desc').value;
        workflow.serverRef = detail.querySelector('#wf-server').value;
        await api.put(`/api/workflows/${workflow.id}`, workflow);
        await load();
        openWorkflowDetail(workflow);
      };

      bindNodeButtons(detail, workflow);
      renderRunInputs(detail, workflow);
      loadWorkflowGallery(workflow.id);
    }

    function switchWorkflowView(detail, view) {
      detail.querySelectorAll('.workflow-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
      });
      detail.querySelector('#workflow-view-setup').classList.toggle('hidden', view !== 'setup');
      detail.querySelector('#workflow-view-run').classList.toggle('hidden', view !== 'run');
      detail.querySelector('#workflow-view-gallery').classList.toggle('hidden', view !== 'gallery');
    }

    function renderNodeList(nodes, allowPromote, readOnly = false) {
      if (!nodes || !nodes.length) return '<div class="muted">No nodes</div>';
      return nodes.map(node => {
        const value = node.currentValue ?? '';
        const inputField = readOnly ? '' : `<input data-node="${node.nodeId}" data-field="${node.fieldPath}" value="${value}" />`;
        const btn = allowPromote
          ? `<button class="secondary" data-action="demote" data-node="${node.nodeId}">Secondary</button>`
          : `<button class="secondary" data-action="promote" data-node="${node.nodeId}">Primary</button>`;
        return `
          <div class="node-item">
            <div><strong>${node.label}</strong> <span class="pill">${node.description}</span></div>
            ${readOnly ? '' : `<div class="row" style="margin-top:6px;">${inputField}</div>`}
            ${readOnly ? '' : `<div class="row" style="margin-top:6px;">${btn}</div>`}
          </div>
        `;
      }).join('');
    }

    const ASPECT_RATIOS = [
      '1:1',
      'landscape (5:4)', 'landscape (4:3)', 'landscape (3:2)',
      'landscape (16:10)', 'landscape (16:9)', 'landscape (21:9)',
      'portrait (4:5)', 'portrait (3:4)', 'portrait (2:3)',
      'portrait (9:10)', 'portrait (9:16)', 'portrait (9:21)'
    ];

    function isImageField(node) {
      const f = (node.fieldPath || '').toLowerCase();
      const l = (node.label || '').toLowerCase();
      return (f === 'image' || f === 'inputs.image' || l === 'image') && node.description !== 'aspect_ratio';
    }

    function isAudioField(node) {
      const f = (node.fieldPath || '').toLowerCase();
      const l = (node.label || '').toLowerCase();
      return f === 'audio' || f === 'inputs.audio' || l === 'audio' || l.includes('audio');
    }

    function isAspectRatioField(node) {
      const f = (node.fieldPath || '').toLowerCase();
      const l = (node.label || '').toLowerCase();
      return f.includes('aspect_ratio') || l.includes('aspect ratio');
    }

    function isResolutionField(node) {
      const f = (node.fieldPath || '').toLowerCase();
      const l = (node.label || '').toLowerCase();
      return f.includes('base_resolution') || l.includes('resolution');
    }

    function renderRunInputs(detail, workflow) {
      renderTemplateControls(detail, workflow);
      const container = detail.querySelector('#run-inputs');
      container.innerHTML = '';
      const inputs = workflow.primaryInputNodes || [];
      if (!inputs.length) {
        container.innerHTML = '<div class="muted">No primary inputs configured.</div>';
        return;
      }
      inputs.forEach(node => {
        const wrap = document.createElement('div');
        wrap.className = 'panel';
        const fieldId = `${node.nodeId}.${node.fieldPath}`;

        if (isImageField(node)) {
          // File upload for image inputs
          wrap.innerHTML = `
            <div class="muted">${fieldId}</div>
            <div class="row" style="align-items:center;gap:8px;">
              <input type="file" accept="image/*" data-node="${node.nodeId}" data-field="${node.fieldPath}" data-upload="true" data-subfolder="" style="flex:1;" />
              <span class="muted upload-status" data-for="${node.nodeId}"></span>
            </div>
            <input type="hidden" data-node="${node.nodeId}" data-field="${node.fieldPath}" data-hidden="true" value="${node.currentValue ?? ''}" />
            ${node.currentValue ? `<div class="muted" style="margin-top:4px;">Current: ${node.currentValue}</div>` : ''}
          `;
        } else if (isAudioField(node)) {
          // File upload for audio inputs (uploads to ComfyUI audio subfolder)
          wrap.innerHTML = `
            <div class="muted">${fieldId}</div>
            <div class="row" style="align-items:center;gap:8px;">
              <input type="file" accept="audio/*" data-node="${node.nodeId}" data-field="${node.fieldPath}" data-upload="true" data-subfolder="audio" style="flex:1;" />
              <span class="muted upload-status" data-for="${node.nodeId}"></span>
            </div>
            <input type="hidden" data-node="${node.nodeId}" data-field="${node.fieldPath}" data-hidden="true" value="${node.currentValue ?? ''}" />
            ${node.currentValue ? `<div class="muted" style="margin-top:4px;">Current: ${node.currentValue}</div>` : ''}
          `;
        } else if (isAspectRatioField(node)) {
          // Dropdown for aspect ratio
          const options = ASPECT_RATIOS.map(ar => {
            const sel = (node.currentValue || '').replace('square ', '').trim() === ar || node.currentValue === ar ? 'selected' : '';
            return `<option value="${ar}" ${sel}>${ar}</option>`;
          }).join('');
          wrap.innerHTML = `
            <div class="muted">${fieldId}</div>
            <select data-node="${node.nodeId}" data-field="${node.fieldPath}">${options}</select>
          `;
        } else if (isResolutionField(node)) {
          // Stepper for base resolution (multiples of 128, min 512)
          const curVal = parseInt(node.currentValue) || 512;
          wrap.innerHTML = `
            <div class="muted">${fieldId}</div>
            <div class="row" style="align-items:center;gap:0;">
              <button class="secondary res-down" style="border-radius:12px 0 0 12px;padding:10px 14px;font-size:18px;"><i class="ph-duotone ph-caret-left"></i></button>
              <input type="number" data-node="${node.nodeId}" data-field="${node.fieldPath}" value="${curVal}" step="128" min="512" max="2048" style="border-radius:0;text-align:center;width:100px;-moz-appearance:textfield;" />
              <button class="secondary res-up" style="border-radius:0 12px 12px 0;padding:10px 14px;font-size:18px;"><i class="ph-duotone ph-caret-right"></i></button>
            </div>
          `;
        } else if (Array.isArray(node.options)) {
          const options = node.options.map(opt => `<option value="${opt}" ${opt == node.currentValue ? 'selected' : ''}>${opt}</option>`).join('');
          wrap.innerHTML = `
            <div class="muted">${fieldId}</div>
            <select data-node="${node.nodeId}" data-field="${node.fieldPath}">${options}</select>
          `;
        } else if (node.type === 'int' || node.type === 'float' || node.type === 'number') {
          const isSeedField = /seed/i.test(node.fieldPath) || /seed/i.test(node.label || '');
          if (isSeedField) {
            wrap.innerHTML = `
              <div class="muted">${fieldId}</div>
              <div class="row" style="align-items:center;gap:0;">
                <input type="number" data-node="${node.nodeId}" data-field="${node.fieldPath}" value="${node.currentValue ?? ''}" style="flex:1;border-radius:12px 0 0 12px;" />
                <button class="secondary" onclick="this.parentElement.querySelector('input').value=-1" title="Randomize seed" style="border-radius:0 12px 12px 0;padding:10px 14px;font-size:18px;"><i class="ph-duotone ph-dice-five"></i></button>
              </div>
              <div class="muted" style="margin-top:4px;font-size:11px">Leave -1 for random</div>
            `;
          } else {
            wrap.innerHTML = `
              <div class="muted">${fieldId}</div>
              <input type="number" data-node="${node.nodeId}" data-field="${node.fieldPath}" value="${node.currentValue ?? ''}" />
            `;
          }
        } else {
          wrap.innerHTML = `
            <div class="muted">${fieldId}</div>
            <input type="text" data-node="${node.nodeId}" data-field="${node.fieldPath}" value="${node.currentValue ?? ''}" />
          `;
        }
        container.appendChild(wrap);
      });

      // Resolution stepper buttons
      container.querySelectorAll('.res-down').forEach(btn => {
        btn.onclick = () => {
          const input = btn.parentElement.querySelector('input[type=number]');
          let val = parseInt(input.value) || 512;
          val = Math.max(512, val - 128);
          input.value = val;
          input.dispatchEvent(new Event('change'));
        };
      });
      container.querySelectorAll('.res-up').forEach(btn => {
        btn.onclick = () => {
          const input = btn.parentElement.querySelector('input[type=number]');
          let val = parseInt(input.value) || 512;
          val = Math.min(2048, val + 128);
          input.value = val;
          input.dispatchEvent(new Event('change'));
        };
      });

      // Image upload handlers
      container.querySelectorAll('input[data-upload="true"]').forEach(fileInput => {
        fileInput.onchange = async () => {
          const file = fileInput.files[0];
          if (!file) return;
          const nodeId = fileInput.dataset.node;
          const field = fileInput.dataset.field;
          const statusEl = container.querySelector(`.upload-status[data-for="${nodeId}"]`);
          const hiddenInput = container.querySelector(`input[data-hidden="true"][data-node="${nodeId}"]`);
          statusEl.textContent = 'Uploading...';
          // Find the server for this workflow
          const server = state.servers.find(s => s.id === workflow.serverRef);
          if (!server) {
            statusEl.textContent = 'No server!';
            return;
          }
          const subfolder = fileInput.dataset.subfolder || '';
          const formData = new FormData();
          formData.append('image', file);
          formData.append('type', 'input');
          if (subfolder) formData.append('subfolder', subfolder);
          try {
            const res = await fetch(`/api/servers/${server.id}/upload`, {
              method: 'POST',
              body: formData
            });
            const result = await res.json();
            if (result.name) {
              const resultSub = result.subfolder || subfolder;
              const filename = resultSub ? `${resultSub}/${result.name}` : result.name;
              hiddenInput.value = filename;
              statusEl.innerHTML = `<i class="ph-duotone ph-check" style="color:var(--success);margin-right:0.35rem"></i>${result.name}`;
              statusEl.style.color = 'var(--success)';
              const node = (workflow.primaryInputNodes || []).find(n => n.nodeId === nodeId && n.fieldPath === field);
              if (node) node.currentValue = filename;
            } else {
              statusEl.textContent = 'Upload failed';
              statusEl.style.color = 'var(--danger)';
            }
          } catch (err) {
            statusEl.textContent = 'Upload error';
            statusEl.style.color = 'var(--danger)';
          }
        };
      });

      // Standard change handlers for non-upload inputs
      container.querySelectorAll('input[data-node]:not([data-upload]):not([data-hidden]), select[data-node]').forEach(input => {
        input.onchange = () => {
          const nodeId = input.dataset.node;
          const field = input.dataset.field;
          const val = input.value;
          const node = (workflow.primaryInputNodes || []).find(n => n.nodeId === nodeId && n.fieldPath === field);
          if (node) {
            node.currentValue = val;
          }
        };
      });

      detail.querySelector('#run-workflow').onclick = async () => runWorkflow(workflow, detail);
      detail.querySelector('#batch-workflow').onclick = async () => toggleBatchPanel(detail);
      detail.querySelector('#save-template').onclick = async () => saveTemplate(detail, workflow);
      setupBatchPanel(detail, workflow);
    }

    function bindNodeButtons(detail, workflow) {
      detail.querySelectorAll('[data-action="promote"]').forEach(btn => {
        btn.onclick = async () => {
          const nodeId = btn.dataset.node;
          const idx = workflow.secondaryInputNodes.findIndex(n => n.nodeId === nodeId);
          if (idx >= 0) {
            const node = workflow.secondaryInputNodes.splice(idx, 1)[0];
            workflow.primaryInputNodes.push(node);
            await api.put(`/api/workflows/${workflow.id}`, workflow);
            openWorkflowDetail(workflow);
          }
        };
      });
      detail.querySelectorAll('[data-action="demote"]').forEach(btn => {
        btn.onclick = async () => {
          const nodeId = btn.dataset.node;
          const idx = workflow.primaryInputNodes.findIndex(n => n.nodeId === nodeId);
          if (idx >= 0) {
            const node = workflow.primaryInputNodes.splice(idx, 1)[0];
            workflow.secondaryInputNodes.push(node);
            await api.put(`/api/workflows/${workflow.id}`, workflow);
            openWorkflowDetail(workflow);
          }
        };
      });
      detail.querySelectorAll('input[data-node]').forEach(input => {
        input.onchange = () => {
          const nodeId = input.dataset.node;
          const field = input.dataset.field;
          const val = input.value;
          const list = workflow.primaryInputNodes.concat(workflow.secondaryInputNodes);
          const node = list.find(n => n.nodeId === nodeId && n.fieldPath === field);
          if (node) {
            node.currentValue = val;
          }
        };
      });
    }

    function renderTemplateControls(detail, workflow) {
      const container = detail.querySelector('#run-templates');
      if (!container) return;
      const templates = state.templates.filter(t => !t.workflowId || t.workflowId === workflow.id);
      const options = templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      container.innerHTML = `
        <div class="panel">
          <div class="row" style="align-items:center;justify-content:space-between;">
            <div style="flex:1;">
              <div class="muted" style="margin-bottom:4px;">Templates</div>
              <select id="template-select">
                <option value="">Select template</option>
                ${options}
              </select>
            </div>
            <button id="delete-template" class="danger">Delete</button>
          </div>
        </div>
      `;
      const select = container.querySelector('#template-select');
      const deleteBtn = container.querySelector('#delete-template');
      select.onchange = () => {
        const templateId = select.value;
        if (!templateId) return;
        const template = templates.find(t => t.id === templateId);
        if (!template) return;
        applyTemplate(detail, workflow, template);
      };
      deleteBtn.onclick = async () => {
        const templateId = select.value;
        if (!templateId) return;
        if (!confirm('Delete template?')) return;
        await api.del(`/api/templates/${templateId}`);
        state.templates = await api.get('/api/templates');
        renderTemplateControls(detail, workflow);
      };
    }

    function applyTemplate(detail, workflow, template) {
      const inputs = template.inputs || {};
      const runInputs = detail.querySelector('#run-inputs');
      Object.entries(inputs).forEach(([key, value]) => {
        if (!key.includes('.')) return;
        const [nodeId, field] = key.split('.', 2);
        let input = runInputs.querySelector(`input[data-hidden="true"][data-node="${nodeId}"][data-field="${field}"]`);
        if (!input) input = runInputs.querySelector(`[data-node="${nodeId}"][data-field="${field}"]`);
        if (!input) return;
        input.value = value;
        input.dispatchEvent(new Event('change'));
      });
      (workflow.primaryInputNodes || []).forEach(node => {
        const key = `${node.nodeId}.${node.fieldPath}`;
        if (key in inputs) {
          node.currentValue = inputs[key];
        }
      });
    }

    async function saveTemplate(detail, workflow) {
      const name = prompt('Template name');
      if (!name) return;
      const inputs = {};
      const runInputs = detail.querySelector('#run-inputs');
      (workflow.primaryInputNodes || []).forEach(node => {
        let el = runInputs.querySelector(`input[data-hidden="true"][data-node="${node.nodeId}"][data-field="${node.fieldPath}"]`);
        if (!el) el = runInputs.querySelector(`[data-node="${node.nodeId}"][data-field="${node.fieldPath}"]`);
        if (el) inputs[`${node.nodeId}.${node.fieldPath}`] = el.value;
      });
      const payload = { name, workflowId: workflow.id, inputs };
      await api.post('/api/templates', payload);
      state.templates = await api.get('/api/templates');
      renderTemplateControls(detail, workflow);
    }

    function getRunInputs(workflow, detail) {
      const runInputs = detail.querySelector('#run-inputs');
      return (workflow.primaryInputNodes || []).map(node => {
        let el = runInputs.querySelector(`input[data-hidden="true"][data-node="${node.nodeId}"][data-field="${node.fieldPath}"]`);
        if (!el) el = runInputs.querySelector(`[data-node="${node.nodeId}"][data-field="${node.fieldPath}"]:not([data-upload])`);
        let val = el ? el.value : node.currentValue;
        if (node.type === 'int') val = parseInt(val, 10) || 0;
        else if (node.type === 'float' || node.type === 'number') val = parseFloat(val) || 0;
        return { ...node, currentValue: val };
      });
    }

    const lastDashInputs = {};
    async function runWorkflow(workflow, detail) {
      const status = detail.querySelector('#run-status');
      const outputContainer = detail.querySelector('#run-output');
      const updatedNodes = getRunInputs(workflow, detail);
      // Check for identical inputs to last run
      const inputKey = JSON.stringify(updatedNodes, Object.keys(updatedNodes).sort());
      if (lastDashInputs[workflow.id] === inputKey) {
        toast('<i class="ph-duotone ph-info" style="color:var(--cyan);margin-right:0.35rem"></i>Same settings as last run — change the prompt, seed, or other settings for a new result.');
        return;
      }
      status.innerHTML = '<span class="status-pulse">Queued...</span>';
      outputContainer.innerHTML = '';
      const res = await api.post(`/api/workflows/${workflow.id}/run`, {
        inputs: updatedNodes,
        primaryInputs: updatedNodes,
        secondaryInputs: workflow.secondaryInputNodes || []
      });
      if (!res.prompt_id) {
        status.innerHTML = '<span class="status-pulse" style="--status-color: var(--danger);">Failed to queue workflow.</span>';
        return;
      }
      lastDashInputs[workflow.id] = inputKey;
      status.innerHTML = `<span class="status-pulse">Queued: ${res.prompt_id}</span>`;
      const promptId = res.prompt_id;
      let attempts = 0;
      const timer = setInterval(async () => {
        attempts++;
        const history = await api.get(`/api/workflows/${workflow.id}/status/${promptId}`);
        if (history && history.status === 'complete' && history.output) {
          clearInterval(timer);
          status.innerHTML = '<span class="status-pulse complete">Complete</span>';
          toast(`<i class="ph-duotone ph-sparkle" style="margin-right:0.35rem"></i>${workflow.emoji || '<i class="ph-duotone ph-puzzle-piece"></i>'} Generation complete`);
          renderOutputPreview(history.output, outputContainer);
          await loadWorkflowGallery(workflow.id);
          await refreshGallery();
          return;
        }
        if (attempts > 30) {
          status.innerHTML = '<span class="status-pulse">Generating...</span>';
        }
      }, 2000);
    }

    function toggleBatchPanel(detail) {
      const panel = detail.querySelector('#batch-panel');
      panel.classList.toggle('hidden');
    }

    function setupBatchPanel(detail, workflow) {
      const panel = detail.querySelector('#batch-panel');
      if (!panel) return;
      const countInput = panel.querySelector('#batch-count');
      const countDisplay = panel.querySelector('#batch-count-display');
      countInput.value = countInput.value || 3;
      countDisplay.textContent = countInput.value;
      countInput.oninput = () => {
        countDisplay.textContent = countInput.value;
      };
      panel.querySelector('#batch-vary-seed').checked = true;
      panel.querySelector('#batch-progress').textContent = '';
      const runButton = panel.querySelector('#run-batch');
      if (runButton) {
        runButton.onclick = async () => runBatch(workflow, detail);
      }
    }

    async function runBatch(workflow, detail) {
      const panel = detail.querySelector('#batch-panel');
      const progress = panel.querySelector('#batch-progress');
      const count = parseInt(panel.querySelector('#batch-count').value || '3', 10);
      const varySeed = panel.querySelector('#batch-vary-seed').checked;
      progress.textContent = 'Queueing batch...';
      const updatedNodes = getRunInputs(workflow, detail);
      const inputs = {};
      updatedNodes.forEach(node => {
        inputs[`${node.nodeId}.${node.fieldPath}`] = node.currentValue;
      });
      const res = await api.post('/api/batch', {
        workflowId: workflow.id,
        inputs,
        variations: count,
        varySeed
      });
      if (!res.batchId) {
        progress.textContent = 'Failed to start batch.';
        return;
      }
      const batchId = res.batchId;
      let attempts = 0;
      const timer = setInterval(async () => {
        attempts++;
        const status = await api.get(`/api/batch/${batchId}`);
        if (status && Array.isArray(status.runs)) {
          const done = status.runs.filter(r => r.status === 'complete').length;
          progress.textContent = `Running ${done}/${status.runs.length}...`;
          if (status.status === 'complete') {
            clearInterval(timer);
            progress.textContent = `Complete (${done}/${status.runs.length})`;
            toast(`<i class="ph-duotone ph-sparkle" style="margin-right:0.35rem"></i>Batch complete — ${done} generations finished`);
            await loadWorkflowGallery(workflow.id);
            await refreshGallery();
          }
        }
        if (attempts > 120) {
          progress.textContent = 'Running...';
        }
      }, 2000);
    }

    function renderOutputPreview(output, container) {
      container.innerHTML = '';
      if (!output || !output.outputPath) return;
      const mediaUrl = `/api/outputs/${encodeURIComponent(output.outputPath)}`;
      if (output.outputType.startsWith('image')) {
        container.innerHTML = `<div class="gallery-thumb"><img src="${mediaUrl}" alt="output" /></div>`;
      } else if (output.outputType.startsWith('video')) {
        container.innerHTML = `<video controls src="${mediaUrl}"></video>`;
      } else if (output.outputType.startsWith('audio')) {
        container.innerHTML = `<audio controls src="${mediaUrl}"></audio>`;
      }
      const dl = document.createElement('a');
      dl.href = mediaUrl;
      dl.textContent = 'Download output';
      dl.download = '';
      dl.style.display = 'inline-block';
      dl.style.marginTop = '8px';
      container.appendChild(dl);
    }

    async function loadWorkflowGallery(workflowId) {
      const detail = document.getElementById('workflow-detail');
      const container = detail.querySelector('#workflow-gallery');
      if (!container) return;
      const outputs = await api.get(`/api/gallery?workflowId=${workflowId}`);
      container.innerHTML = '';
      if (!outputs.length) {
        container.innerHTML = '<div class="muted">No outputs yet.</div>';
        return;
      }
      outputs.forEach(output => {
        container.appendChild(buildGalleryCard(output, false));
      });
    }

    function populateGalleryFilter() {
      const filter = document.getElementById('gallery-filter');
      filter.innerHTML = '<option value="">All workflows</option>';
      state.workflows.forEach(wf => {
        const opt = document.createElement('option');
        opt.value = wf.id;
        opt.textContent = `${wf.emoji || ''} ${wf.title}`.trim();
        filter.appendChild(opt);
      });
    }

    async function refreshGallery() {
      const filter = document.getElementById('gallery-filter');
      const workflowId = filter.value;
      const url = workflowId ? `/api/gallery?workflowId=${workflowId}` : '/api/gallery';
      const outputs = await api.get(url);
      const container = document.getElementById('gallery-list');
      container.innerHTML = '';
      if (!outputs.length) {
        container.innerHTML = '<div class="muted">No outputs yet.</div>';
        return;
      }
      outputs.forEach(output => {
        container.appendChild(buildGalleryCard(output, true));
      });
    }

    function buildGalleryCard(output, showWorkflow) {
      const card = document.createElement('div');
      card.className = 'gallery-card';
      const mediaUrl = output.outputPath ? `/api/outputs/${encodeURIComponent(output.outputPath)}` : '';
      let mediaHtml = '<div class="muted">No preview</div>';
      if (mediaUrl) {
        if (output.outputType.startsWith('image')) {
          mediaHtml = `<img src="${mediaUrl}" alt="output" />`;
        } else if (output.outputType.startsWith('video')) {
          mediaHtml = `<video src="${mediaUrl}"></video>`;
        } else if (output.outputType.startsWith('audio')) {
          mediaHtml = `<div class="muted">Audio</div>`;
        }
      }
      const inputs = Object.entries(output.inputValues || {}).map(([key, val]) => `<div><span class="muted">${key}</span>: ${val}</div>`).join('');
      const batchTag = output.batchId ? `<div class="tag">Batch ${output.variationIndex || ''}/${output.batchCount || ''}</div>` : '';
      const pipelineTag = output.pipelineId ? `<div class="tag">Pipeline ${output.stepIndex || ''}/${output.stepCount || ''}</div>` : '';
      card.innerHTML = `
        <div class="gallery-thumb">${mediaHtml}</div>
        <div class="gallery-meta">${new Date(output.timestamp).toLocaleString()}</div>
        ${showWorkflow ? `<div class="tag">${output.workflowTitle || 'Workflow'}</div>` : ''}
        ${batchTag}
        ${pipelineTag}
        <div class="gallery-meta">${inputs || '—'}</div>
        <div class="row">
          <button class="secondary" data-action="download">Download</button>
          <button class="danger" data-action="delete">Delete</button>
        </div>
      `;
      const thumb = card.querySelector('.gallery-thumb');
      thumb.onclick = () => openModal(output);
      card.querySelector('[data-action="download"]').onclick = () => {
        if (!mediaUrl) return;
        const link = document.createElement('a');
        link.href = mediaUrl;
        link.download = '';
        link.click();
      };
      card.querySelector('[data-action="delete"]').onclick = async () => {
        if (!confirm('Delete output?')) return;
        await api.del(`/api/gallery/${output.id}`);
        await refreshGallery();
        if (state.activeWorkflow) {
          await loadWorkflowGallery(state.activeWorkflow.id);
        }
      };
      return card;
    }

    function openModal(output) {
      const modal = document.getElementById('preview-modal');
      const media = document.getElementById('modal-media');
      const meta = document.getElementById('modal-meta');
      const mediaUrl = output.outputPath ? `/api/outputs/${encodeURIComponent(output.outputPath)}` : '';
      media.innerHTML = '';
      if (output.outputType.startsWith('image')) {
        media.innerHTML = `<img src="${mediaUrl}" alt="output" />`;
      } else if (output.outputType.startsWith('video')) {
        media.innerHTML = `<video controls src="${mediaUrl}"></video>`;
      } else if (output.outputType.startsWith('audio')) {
        media.innerHTML = `<audio controls src="${mediaUrl}"></audio>`;
      }
      const inputs = Object.entries(output.inputValues || {}).map(([key, val]) => `<div><strong>${key}</strong>: ${val}</div>`).join('');
      const batchLine = output.batchId ? `<div class="status-pill">Batch ${output.variationIndex || ''}/${output.batchCount || ''}</div>` : '';
      meta.innerHTML = `
        <div><strong>${output.workflowTitle || 'Workflow'}</strong></div>
        <div class="muted">${new Date(output.timestamp).toLocaleString()}</div>
        <div class="status-pill"><i class="ph-duotone ph-circle" style="color:var(--success);margin-right:0.35rem"></i>${output.status || 'complete'}</div>
        ${batchLine}
        <div>${inputs || 'No inputs recorded.'}</div>
        <div class="row">
          <button class="secondary" onclick="window.open('${mediaUrl}','_blank')">Open</button>
          <button onclick="document.getElementById('preview-modal').classList.remove('active')">Close</button>
        </div>
      `;
      modal.classList.add('active');
    }

    document.getElementById('preview-modal').onclick = (event) => {
      if (event.target.id === 'preview-modal') {
        document.getElementById('preview-modal').classList.remove('active');
      }
    };

    document.getElementById('add-server').onclick = () => openServerForm();
    document.getElementById('add-workflow').onclick = () => openWorkflowForm();
    document.getElementById('add-pipeline').onclick = () => openPipelineBuilder();
    document.getElementById('refresh-gallery').onclick = () => refreshGallery();
    document.getElementById('gallery-filter').onchange = () => refreshGallery();

    function openWorkflowForm(workflow) {
      const template = document.getElementById('workflow-form');
      const form = template.content.cloneNode(true);
      const panel = form.querySelector('.panel');
      const title = panel.querySelector('[name=title]');
      const emoji = panel.querySelector('[name=emoji]');
      const description = panel.querySelector('[name=description]');
      const serverRef = panel.querySelector('[name=serverRef]');
      serverRef.innerHTML = state.servers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      if (workflow) {
        title.value = workflow.title;
        emoji.value = workflow.emoji;
        description.value = workflow.description;
        serverRef.value = workflow.serverRef;
      }
      panel.querySelector('.save').onclick = async () => {
        const payload = {
          title: title.value,
          emoji: emoji.value,
          description: description.value,
          serverRef: serverRef.value,
          workflowJson: workflow ? workflow.workflowJson : {},
          primaryInputNodes: workflow ? workflow.primaryInputNodes : [],
          secondaryInputNodes: workflow ? workflow.secondaryInputNodes : [],
          primaryOutputNodes: workflow ? workflow.primaryOutputNodes : [],
          secondaryOutputNodes: workflow ? workflow.secondaryOutputNodes : []
        };
        if (workflow) {
          await api.put(`/api/workflows/${workflow.id}`, payload);
        } else {
          await api.post('/api/workflows', payload);
        }
        await load();
      };
      panel.querySelector('.cancel').onclick = () => load();
      const container = document.getElementById('workflow-cards');
      container.innerHTML = '';
      container.appendChild(panel);
    }

    document.getElementById('import-workflow').onclick = () => {
      document.getElementById('import-file').click();
    };

    document.getElementById('import-file').onchange = async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const text = await file.text();
      const wfJson = JSON.parse(text);
      const serverRef = state.servers[0]?.id || '';
      const payload = {
        workflowJson: wfJson,
        title: file.name,
        serverRef
      };
      await api.post('/api/workflows/import', payload);
      await load();
    };

    function renderPipelines() {
      const list = document.getElementById('pipeline-list');
      const builder = document.getElementById('pipeline-builder');
      if (!list || !builder) return;
      list.innerHTML = '';
      builder.innerHTML = '<div class="muted">Select workflows and configure inputs to build a pipeline.</div>';
      state.pipelines.forEach(pipe => {
        const card = document.createElement('div');
        card.className = 'panel';
        const steps = (pipe.steps || []).map((step, idx) => {
          return `<div class="muted">${idx + 1}. ${step.workflowId}</div>`;
        }).join('');
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div>
              <strong>${pipe.name || 'Pipeline'}</strong>
              <div class="muted">${steps || 'No steps'}</div>
            </div>
            <div class="row">
              <button class="secondary" data-action="run">Run</button>
              <button class="danger" data-action="delete">Delete</button>
            </div>
          </div>
        `;
        card.querySelector('[data-action="run"]').onclick = () => runPipeline(pipe);
        card.querySelector('[data-action="delete"]').onclick = async () => {
          if (!confirm('Delete pipeline?')) return;
          await api.del(`/api/pipelines/${pipe.id}`);
          state.pipelines = await api.get('/api/pipelines');
          renderPipelines();
        };
        list.appendChild(card);
      });
    }

    function openPipelineBuilder() {
      const builder = document.getElementById('pipeline-builder');
      if (!builder) return;
      const workflowOptions = state.workflows.map(w => `<option value="${w.id}">${w.title}</option>`).join('');
      builder.innerHTML = `
        <div class="panel">
          <div class="row" style="align-items:center;gap:12px;">
            <label style="flex:1;">Pipeline name
              <input id="pipeline-name" placeholder="My pipeline" />
            </label>
            <button class="secondary" id="add-step">Add Step</button>
          </div>
          <div id="pipeline-steps" class="grid" style="margin-top:12px;"></div>
          <div class="row" style="margin-top:12px;justify-content:flex-end;">
            <button id="save-pipeline" class="secondary">Save</button>
            <button id="run-pipeline">Run Pipeline</button>
          </div>
          <div id="pipeline-status" class="muted"></div>
        </div>
      `;
      const stepsContainer = builder.querySelector('#pipeline-steps');
      const addStep = () => {
        const stepCard = document.createElement('div');
        stepCard.className = 'panel';
        stepCard.innerHTML = `
          <div class="row" style="align-items:center;gap:12px;">
            <label style="flex:1;">Workflow
              <select class="pipeline-workflow">${workflowOptions}</select>
            </label>
            <button class="danger" data-action="remove">Remove</button>
          </div>
          <label>Inputs (node.field=value, comma-separated)
            <input class="pipeline-inputs" placeholder="node.field=__prev__" />
          </label>
        `;
        stepCard.querySelector('[data-action="remove"]').onclick = () => stepCard.remove();
        stepsContainer.appendChild(stepCard);
      };
      builder.querySelector('#add-step').onclick = addStep;
      addStep();

      builder.querySelector('#save-pipeline').onclick = async () => {
        const name = builder.querySelector('#pipeline-name').value || 'Pipeline';
        const steps = Array.from(builder.querySelectorAll('.pipeline-workflow')).map((sel, idx) => {
          const inputsRaw = builder.querySelectorAll('.pipeline-inputs')[idx].value || '';
          const inputs = {};
          inputsRaw.split(',').map(s => s.trim()).filter(Boolean).forEach(pair => {
            const [key, val] = pair.split('=');
            if (key) inputs[key] = val || '';
          });
          return { workflowId: sel.value, inputs };
        });
        await api.post('/api/pipelines', { name, steps });
        state.pipelines = await api.get('/api/pipelines');
        renderPipelines();
      };

      builder.querySelector('#run-pipeline').onclick = async () => {
        const steps = Array.from(builder.querySelectorAll('.pipeline-workflow')).map((sel, idx) => {
          const inputsRaw = builder.querySelectorAll('.pipeline-inputs')[idx].value || '';
          const inputs = {};
          inputsRaw.split(',').map(s => s.trim()).filter(Boolean).forEach(pair => {
            const [key, val] = pair.split('=');
            if (key) inputs[key] = val || '';
          });
          return { workflowId: sel.value, inputs };
        });
        const status = builder.querySelector('#pipeline-status');
        status.textContent = 'Running...';
        const res = await api.post('/api/pipelines/run', { steps });
        if (res.pipelineId) {
          pollPipeline(res.pipelineId, status);
        } else {
          status.textContent = 'Failed to start pipeline.';
        }
      };
    }

    async function runPipeline(pipe) {
      const builder = document.getElementById('pipeline-builder');
      if (!builder) return;
      const status = document.createElement('div');
      status.className = 'muted';
      builder.innerHTML = '';
      builder.appendChild(status);
      status.textContent = 'Running...';
      const res = await api.post('/api/pipelines/run', { steps: pipe.steps || [] });
      if (res.pipelineId) {
        pollPipeline(res.pipelineId, status);
      } else {
        status.textContent = 'Failed to start pipeline.';
      }
    }

    function pollPipeline(pipelineId, statusEl) {
      const timer = setInterval(async () => {
        const res = await api.get(`/api/pipelines/run/${pipelineId}`);
        if (res.status === 'complete' || res.status === 'error') {
          clearInterval(timer);
          statusEl.textContent = `Pipeline ${res.status}`;
          await refreshGallery();
          if (state.activeWorkflow) {
            await loadWorkflowGallery(state.activeWorkflow.id);
          }
          return;
        }
        statusEl.textContent = `Running step ${res.currentStep || 0}/${(res.steps || []).length}`;
      }, 2000);
    }

    load();
  </script>
</body>
</html>
